<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leaderboard - Daily Exam Quiz Portal</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- FontAwesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">
        <i class="fas fa-graduation-cap me-2"></i>Quiz Portal
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i>Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="leaderboard.html"><i class="fas fa-trophy me-1"></i>Leaderboard</a></li>
          <li class="nav-item"><a class="nav-link" href="admin.html"><i class="fas fa-shield-alt me-1"></i>Admin</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-5">
    <div class="text-center mb-4">
      <h1 class="display-4 fw-bold animate-fade-in">
        <i class="fas fa-trophy text-warning me-2"></i>Live Leaderboard
      </h1>
      <p class="lead"><i class="fas fa-info-circle me-2"></i>Rankings updated in real-time</p>
      <div class="badge bg-success fs-6 pulse-animation">
        <i class="fas fa-sync-alt me-2"></i>Auto-refreshes every 30 seconds
      </div>
    </div>

    <!-- Quiz Selector -->
    <div class="card shadow-sm border-0 mb-4">
      <div class="card-body">
        <div class="row align-items-center g-3">
          <div class="col-md-6">
            <label class="form-label fw-semibold mb-2">
              <i class="fas fa-filter me-2 text-primary"></i>Select Quiz:
            </label>
            <select class="form-select form-select-lg" id="quizSelector">
              <option value="all">üèÜ All Quizzes Combined</option>
            </select>
          </div>
          <div class="col-md-6">
            <div class="d-flex gap-2 align-items-end h-100">
              <button class="btn btn-primary" onclick="loadLeaderboard()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
              </button>
              <button class="btn btn-warning" onclick="resetFilters()">
                <i class="fas fa-redo me-2"></i>Reset Filters
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quiz Info Banner (shown when specific quiz selected) -->
    <div class="alert alert-info shadow-sm" id="quizInfoBanner" style="display:none;">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="mb-2">
            <i class="fas fa-book-reader me-2"></i>
            <strong id="selectedQuizSubject">Subject</strong>
          </h5>
          <p class="mb-0">
            <i class="fas fa-calendar me-2"></i><span id="selectedQuizDate">Date</span> &nbsp;|&nbsp;
            <i class="fas fa-question-circle me-2"></i><span id="selectedQuizQuestions">0</span> Questions &nbsp;|&nbsp;
            <i class="fas fa-clock me-2"></i><span id="selectedQuizDuration">0</span> Minutes
          </p>
        </div>
        <div class="col-md-4 text-end">
          <button class="btn btn-sm btn-outline-primary" onclick="viewAllQuizzes()">
            <i class="fas fa-eye me-1"></i>View All Quizzes
          </button>
        </div>
      </div>
    </div>

    <!-- Time Period Tabs -->
    <ul class="nav nav-pills mb-4 justify-content-center" id="periodTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-period="today" type="button" role="tab">
          <i class="fas fa-calendar-day me-1"></i>Today
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-period="week" type="button" role="tab">
          <i class="fas fa-calendar-week me-1"></i>This Week
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-period="month" type="button" role="tab">
          <i class="fas fa-calendar-alt me-1"></i>This Month
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-period="all" type="button" role="tab">
          <i class="fas fa-infinity me-1"></i>All Time
        </button>
      </li>
    </ul>

    <!-- Stats Dashboard -->
    <div class="row g-3 mb-4">
      <div class="col-lg-3 col-md-6">
        <div class="card text-center stat-card shadow-sm">
          <div class="card-body">
            <i class="fas fa-users fa-3x text-primary mb-2"></i>
            <h3 id="totalParticipants" class="mb-1">0</h3>
            <p class="mb-0 text-muted">Total Participants</p>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card text-center stat-card shadow-sm">
          <div class="card-body">
            <i class="fas fa-chart-line fa-3x text-success mb-2"></i>
            <h3 id="averageScore" class="mb-1">0%</h3>
            <p class="mb-0 text-muted">Average Score</p>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card text-center stat-card shadow-sm">
          <div class="card-body">
            <i class="fas fa-star fa-3x text-warning mb-2"></i>
            <h3 id="highestScore" class="mb-1">0%</h3>
            <p class="mb-0 text-muted">Highest Score</p>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6">
        <div class="card text-center stat-card shadow-sm">
          <div class="card-body">
            <i class="fas fa-ranking-star fa-3x text-info mb-2"></i>
            <h3 id="yourRank" class="mb-1">-</h3>
            <p class="mb-0 text-muted">Your Rank</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Search and Download -->
    <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
      <input type="text" id="searchUser" class="form-control" style="max-width: 400px;" placeholder="üîç Search by name..." />
      <button class="btn btn-danger" onclick="downloadPDF()">
        <i class="fas fa-file-pdf me-2"></i>Download PDF
      </button>
    </div>

    <!-- Leaderboard Table -->
    <div class="card shadow-lg border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0" id="leaderboardTable">
            <thead class="table-dark">
              <tr>
                <th><i class="fas fa-medal me-1"></i>Rank</th>
                <th><i class="fas fa-user me-1"></i>Name</th>
                <th><i class="fas fa-check-circle me-1"></i>Score</th>
                <th><i class="fas fa-percentage me-1"></i>Accuracy</th>
                <th><i class="fas fa-clock me-1"></i>Time Taken</th>
                <th><i class="fas fa-calendar me-1"></i>Date</th>
              </tr>
            </thead>
            <tbody id="leaderboardBody">
              <tr>
                <td colspan="6" class="text-center py-5">
                  <div class="spinner-border text-primary"></div>
                  <p class="mt-2">Loading leaderboard...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-dark text-white text-center py-4 mt-5">
    <div class="container">
      <p class="mb-2"><i class="fas fa-copyright me-1"></i> 2025 Daily Exam Quiz Portal. All rights reserved.</p>
      <p class="mb-0">
        <a href="#" class="text-white me-3"><i class="fab fa-facebook fa-lg"></i></a>
        <a href="#" class="text-white me-3"><i class="fab fa-twitter fa-lg"></i></a>
        <a href="#" class="text-white me-3"><i class="fab fa-telegram fa-lg"></i></a>
        <a href="#" class="text-white"><i class="fab fa-whatsapp fa-lg"></i></a>
      </p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    let currentPeriod = "today";
    let currentQuizId = "all";
    let allLeaderboardData = [];

    window.addEventListener("DOMContentLoaded", function () {
      loadQuizSelector();
      checkForSpecificQuiz();
      loadLeaderboard();
      setupEventListeners();
      // Auto-refresh every 30 seconds
      setInterval(loadLeaderboard, 30000);
    });

    // Check if redirected from results page with specific quiz
    function checkForSpecificQuiz() {
      const urlParams = new URLSearchParams(window.location.search);
      const quizId = urlParams.get('quizId');
      
      if (quizId && quizId !== 'all') {
        currentQuizId = quizId;
        const selector = document.getElementById('quizSelector');
        if (selector) {
          selector.value = quizId;
        }
        console.log('üìç Showing leaderboard for quiz:', quizId);
      }
    }

    // Load quiz selector dropdown
    function loadQuizSelector() {
      const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
      const selector = document.getElementById('quizSelector');
      
      // Sort by date (newest first)
      quizzes.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Clear existing options except "All Quizzes"
      selector.innerHTML = '<option value="all">üèÜ All Quizzes Combined</option>';
      
      quizzes.forEach(quiz => {
        const option = document.createElement('option');
        option.value = quiz.quizId;
        option.textContent = `üìö ${quiz.subject} - ${new Date(quiz.date).toLocaleDateString('en-IN')}`;
        selector.appendChild(option);
      });
      
      // Set current selection
      if (currentQuizId) {
        selector.value = currentQuizId;
      }
      
      console.log(`‚úÖ Loaded ${quizzes.length} quizzes in selector`);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Quiz selector change
      document.getElementById('quizSelector').addEventListener('change', function(e) {
        currentQuizId = e.target.value;
        loadLeaderboard();
      });
      
      // Period tabs
      document.querySelectorAll("#periodTabs button").forEach((btn) => {
        btn.addEventListener("click", function () {
          document.querySelectorAll("#periodTabs button").forEach((b) => b.classList.remove("active"));
          this.classList.add("active");
          currentPeriod = this.dataset.period;
          loadLeaderboard();
        });
      });
      
      // Search
      document.getElementById("searchUser").addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll("#leaderboardBody tr");

        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? "" : "none";
        });
      });
    }

    function loadLeaderboard() {
      const attempts = JSON.parse(localStorage.getItem("quizAttempts") || "[]");
      const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
      
      console.log(`üîç Loading leaderboard for: ${currentQuizId}, period: ${currentPeriod}`);
      
      if (attempts.length === 0) {
        generateSampleData();
        return;
      }

      // Filter by selected quiz
      let filteredAttempts = attempts;
      if (currentQuizId !== 'all') {
        filteredAttempts = attempts.filter(a => a.quizId === currentQuizId);
        showQuizInfo(currentQuizId, quizzes);
      } else {
        hideQuizInfo();
      }
      
      // Filter by time period
      filteredAttempts = filterByPeriod(filteredAttempts, currentPeriod);
      
      // Remove duplicates (keep best attempt per user per quiz)
      filteredAttempts = removeDuplicates(filteredAttempts);
      
      // Sort by score descending, then by time ascending
      filteredAttempts.sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return timeToSeconds(a.time) - timeToSeconds(b.time);
      });

      allLeaderboardData = filteredAttempts;
      updateStats(filteredAttempts);
      displayLeaderboard(filteredAttempts);
    }

    function showQuizInfo(quizId, quizzes) {
      const quiz = quizzes.find(q => q.quizId === quizId);
      if (quiz) {
        document.getElementById('quizInfoBanner').style.display = 'block';
        document.getElementById('selectedQuizSubject').textContent = quiz.subject;
        document.getElementById('selectedQuizDate').textContent = new Date(quiz.date).toLocaleDateString('en-IN');
        document.getElementById('selectedQuizQuestions').textContent = quiz.totalQuestions;
        document.getElementById('selectedQuizDuration').textContent = Math.ceil(quiz.timeLimit / 60);
      }
    }

    function hideQuizInfo() {
      document.getElementById('quizInfoBanner').style.display = 'none';
    }

    function removeDuplicates(attempts) {
      const uniqueMap = new Map();
      
      attempts.forEach(attempt => {
        const key = `${attempt.email}_${attempt.quizId}`;
        
        if (!uniqueMap.has(key)) {
          uniqueMap.set(key, attempt);
        } else {
          const existing = uniqueMap.get(key);
          // Keep better score or faster time
          if (attempt.score > existing.score || 
              (attempt.score === existing.score && timeToSeconds(attempt.time) < timeToSeconds(existing.time))) {
            uniqueMap.set(key, attempt);
          }
        }
      });
      
      return Array.from(uniqueMap.values());
    }

    function timeToSeconds(time) {
      if (!time) return 999999;
      const parts = time.split(':');
      return parseInt(parts[0]) * 60 + parseInt(parts[1]);
    }

    function generateSampleData() {
      const sampleData = [
        { rank: 1, name: "Rahul Sharma", email: "rahul@example.com", score: 28, total: 30, accuracy: 93.33, time: "25:30", date: "2025-10-19" },
        { rank: 2, name: "Priya Singh", email: "priya@example.com", score: 27, total: 30, accuracy: 90.0, time: "27:15", date: "2025-10-19" },
        { rank: 3, name: "Amit Kumar", email: "amit@example.com", score: 26, total: 30, accuracy: 86.67, time: "23:45", date: "2025-10-19" },
        { rank: 4, name: "Sneha Patel", email: "sneha@example.com", score: 25, total: 30, accuracy: 83.33, time: "28:00", date: "2025-10-19" },
        { rank: 5, name: "Vikram Reddy", email: "vikram@example.com", score: 24, total: 30, accuracy: 80.0, time: "26:20", date: "2025-10-19" },
      ];

      allLeaderboardData = sampleData;
      updateStats(sampleData);
      displayLeaderboard(sampleData);
    }

    function filterByPeriod(attempts, period) {
      const now = new Date();
      const today = now.toISOString().split("T")[0];

      return attempts.filter((attempt) => {
        const attemptDate = new Date(attempt.date);
        switch (period) {
          case "today":
            return attempt.date === today;
          case "week":
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            return attemptDate >= weekAgo;
          case "month":
            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            return attemptDate >= monthAgo;
          default:
            return true;
        }
      });
    }

    function updateStats(data) {
      document.getElementById("totalParticipants").textContent = data.length;

      if (data.length > 0) {
        const avgScore = data.reduce((sum, d) => sum + (d.accuracy || 0), 0) / data.length;
        document.getElementById("averageScore").textContent = avgScore.toFixed(1) + "%";

        const maxScore = Math.max(...data.map((d) => d.accuracy || 0));
        document.getElementById("highestScore").textContent = maxScore.toFixed(1) + "%";

        const session = JSON.parse(localStorage.getItem('userSession') || '{}');
        if (session.email) {
          const userIndex = data.findIndex(d => d.email === session.email);
          if (userIndex >= 0) {
            document.getElementById("yourRank").textContent = `#${userIndex + 1}`;
          } else {
            document.getElementById("yourRank").textContent = '-';
          }
        }
      }
    }

    function displayLeaderboard(data) {
      const tbody = document.getElementById("leaderboardBody");
      const session = JSON.parse(localStorage.getItem('userSession') || '{}');
      const currentUserEmail = session.email || "";

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><i class="fas fa-inbox fa-3x text-muted mb-3"></i><p>No attempts for this quiz/period yet</p></td></tr>';
        return;
      }

      tbody.innerHTML = data.map((entry, index) => {
          const isCurrentUser = entry.email === currentUserEmail;
          const rowClass = isCurrentUser ? "table-warning" : "";
          let trophy = "";

          if (index === 0) trophy = "ü•á";
          else if (index === 1) trophy = "ü•à";
          else if (index === 2) trophy = "ü•â";

          return `
            <tr class="${rowClass}">
              <td class="fw-bold">${trophy} #${index + 1}</td>
              <td>
                <i class="fas fa-user-circle me-2"></i>${entry.userName || entry.name} 
                ${isCurrentUser ? '<span class="badge bg-primary ms-2">You</span>' : ""}
              </td>
              <td><strong>${entry.score}/${entry.total || 30}</strong></td>
              <td><span class="badge bg-success">${(entry.accuracy || 0).toFixed(2)}%</span></td>
              <td><i class="fas fa-stopwatch me-1"></i>${entry.time}</td>
              <td><i class="fas fa-calendar-day me-1"></i>${entry.date}</td>
            </tr>
          `;
        }).join("");
    }

    function resetFilters() {
      currentQuizId = 'all';
      currentPeriod = 'today';
      document.getElementById('quizSelector').value = 'all';
      document.querySelectorAll("#periodTabs button").forEach((b) => b.classList.remove("active"));
      document.querySelector("#periodTabs button[data-period='today']").classList.add("active");
      loadLeaderboard();
    }

    function viewAllQuizzes() {
      window.location.href = 'index.html';
    }

    // PDF Download Function
    function downloadPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Get quiz info
        const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
        const quiz = quizzes.find(q => q.quizId === currentQuizId);
        const quizName = currentQuizId === 'all' ? 'All Quizzes' : (quiz ? quiz.subject : 'Selected Quiz');

        // Add title
        doc.setFontSize(20);
        doc.setTextColor(99, 102, 241);
        doc.text("Quiz Portal - Leaderboard", 105, 20, { align: "center" });

        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text(`Quiz: ${quizName}`, 105, 30, { align: "center" });
        doc.text(`Period: ${currentPeriod.toUpperCase()}`, 105, 37, { align: "center" });
        doc.text(`Generated: ${new Date().toLocaleString()}`, 105, 44, { align: "center" });

        // Prepare table data
        const tableData = allLeaderboardData.map((entry, index) => [
          index + 1,
          entry.userName || entry.name,
          `${entry.score}/${entry.total || 30}`,
          `${(entry.accuracy || 0).toFixed(2)}%`,
          entry.time,
          entry.date
        ]);

        // Add table
        doc.autoTable({
          startY: 50,
          head: [["Rank", "Name", "Score", "Accuracy", "Time", "Date"]],
          body: tableData,
          theme: "grid",
          headStyles: { fillColor: [99, 102, 241], textColor: 255 },
          alternateRowStyles: { fillColor: [249, 250, 251] },
          styles: { fontSize: 10 },
        });

        // Save PDF
        const fileName = `leaderboard-${quizName.replace(/\s+/g, '-')}-${currentPeriod}-${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);

        Swal.fire({
          title: "Success!",
          text: "Leaderboard PDF downloaded!",
          icon: "success",
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error("PDF generation error:", error);
        Swal.fire({
          title: "Error",
          text: "Failed to generate PDF",
          icon: "error"
        });
      }
    }
  </script>

  <style>
    .pulse-animation {
      animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .animate-fade-in {
      animation: fadeIn 0.8s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .stat-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }

    .table-hover tbody tr:hover {
      background-color: rgba(99, 102, 241, 0.1);
    }
  </style>
</body>
</html>
