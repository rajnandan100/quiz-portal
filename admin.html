<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Quiz Creator</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger sticky-top shadow">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-shield-alt me-2"></i>Admin Panel
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="leaderboard.html">
                            <i class="fas fa-trophy me-1"></i>Leaderboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="adminLogout()">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Login Modal -->
    <div class="modal fade" id="adminLoginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-lock me-2"></i>Admin Authentication Required
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-shield fa-5x text-danger"></i>
                    </div>
                    <form id="adminLoginForm">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-key me-2 text-danger"></i>Admin Password
                            </label>
                            <input type="password" class="form-control form-control-lg" id="adminPassword" 
                                   placeholder="Enter admin password" required minlength="6" autocomplete="off">
                            <small class="text-muted">Default password: <code>admin123</code></small>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 btn-lg">
                            <i class="fas fa-sign-in-alt me-2"></i>Login to Admin Panel
                        </button>
                    </form>
                    <div id="loginError" class="alert alert-danger mt-3" style="display:none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="loginErrorText">Invalid password!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Admin Content -->
    <main class="container my-5" id="adminContent" style="display:none;">
        <!-- API Connection Status -->
        <div class="alert alert-info alert-dismissible fade show" role="alert" id="apiStatusAlert">
            <i class="fas fa-info-circle me-2"></i>
            <strong>API Status:</strong> <span id="apiStatusText">Checking connection...</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <!-- Quiz Creation Form -->
            <div class="col-lg-8">
                <div class="card shadow-lg border-0 mb-4">
                    <div class="card-header bg-danger text-white py-3">
                        <h4 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>Create New Quiz
                        </h4>
                        <small class="opacity-75">Fill in the details below to create a new quiz</small>
                    </div>
                    <div class="card-body p-4">
                        <form id="quizCreationForm">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-calendar-alt text-danger me-2"></i>Quiz Date *
                                    </label>
                                    <input type="date" class="form-control" id="quizDateInput" 
                                           name="date" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-book text-danger me-2"></i>Subject *
                                    </label>
                                    <select class="form-select" id="subjectInput" name="subject" required>
                                        <option value="">Select subject...</option>
                                        <option value="General Knowledge">General Knowledge</option>
                                        <option value="English">English</option>
                                        <option value="Reasoning">Reasoning</option>
                                        <option value="Mathematics">Mathematics</option>
                                        <option value="General Studies">General Studies</option>
                                        <option value="Current Affairs">Current Affairs</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-code text-danger me-2"></i>Questions JSON *
                                </label>
                                <textarea class="form-control font-monospace" id="questionsJson" 
                                          name="questionsJson" rows="12" required 
                                          placeholder='Paste your questions in JSON format. Example:
[
  {
    "question": "What is the capital of India?",
    "options": ["Mumbai", "New Delhi", "Kolkata", "Chennai"],
    "correctAnswer": 1,
    "explanation": "New Delhi is the capital of India since 1911.",
    "timeAllocation": 60
  }
]'></textarea>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <strong>Format:</strong> Array of question objects. Each question needs: 
                                    question, options (array of 4), correctAnswer (index 0-3), explanation, timeAllocation (seconds)
                                </div>
                            </div>

                            <div class="card bg-light border-0 mb-3">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-4">
                                            <div class="mb-2">
                                                <i class="fas fa-list-ol fa-2x text-primary"></i>
                                            </div>
                                            <strong>Total Questions:</strong>
                                            <h4 id="questionCount" class="text-primary mb-0">0</h4>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-2">
                                                <i class="fas fa-clock fa-2x text-success"></i>
                                            </div>
                                            <strong>Total Time:</strong>
                                            <h4 id="totalTime" class="text-success mb-0">0 minutes</h4>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-2">
                                                <i class="fas fa-check-circle fa-2x text-info"></i>
                                            </div>
                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                    onclick="validateJSON()">
                                                <i class="fas fa-check me-1"></i>Validate JSON
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-2 flex-wrap">
                                <button type="submit" class="btn btn-danger btn-lg px-4" id="createQuizBtn">
                                    <i class="fas fa-cloud-upload-alt me-2"></i>Create Quiz
                                </button>
                                <button type="reset" class="btn btn-outline-secondary btn-lg px-4">
                                    <i class="fas fa-redo me-2"></i>Reset Form
                                </button>
                                <button type="button" class="btn btn-outline-info btn-lg px-4" onclick="copyTemplate()">
                                    <i class="fas fa-copy me-2"></i>Copy Template
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Help & Instructions Sidebar -->
            <div class="col-lg-4">
                <!-- Quick Guide -->
                <div class="card shadow border-0 mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Quick Guide
                        </h5>
                    </div>
                    <div class="card-body">
                        <ol class="mb-0">
                            <li class="mb-2">
                                <i class="fas fa-angle-right me-1 text-info"></i>
                                Select quiz date and subject
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-angle-right me-1 text-info"></i>
                                Paste questions in JSON format
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-angle-right me-1 text-info"></i>
                                Click "Validate JSON" to check format
                            </li>
                            <li class="mb-2">
                                <i class="fas fa-angle-right me-1 text-info"></i>
                                Review question count and time
                            </li>
                            <li>
                                <i class="fas fa-angle-right me-1 text-info"></i>
                                Click "Create Quiz" to save
                            </li>
                        </ol>
                    </div>
                </div>

                <!-- JSON Template -->
                <div class="card shadow border-0 mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-code me-2"></i>JSON Template
                        </h5>
                    </div>
                    <div class="card-body">
                        <pre class="bg-light p-3 rounded small mb-3" style="font-size:11px; max-height: 300px; overflow-y: auto;">[
  {
    "question": "Your question here?",
    "options": [
      "Option A",
      "Option B",
      "Option C",
      "Option D"
    ],
    "correctAnswer": 1,
    "explanation": "Detailed explanation",
    "timeAllocation": 60
  },
  {
    "question": "Another question?",
    "options": [
      "Choice 1",
      "Choice 2",
      "Choice 3",
      "Choice 4"
    ],
    "correctAnswer": 0,
    "explanation": "Why this is correct",
    "timeAllocation": 60
  }
]</pre>
                        <button class="btn btn-warning w-100" onclick="copyTemplate()">
                            <i class="fas fa-copy me-2"></i>Copy Template to Clipboard
                        </button>
                    </div>
                </div>

                <!-- Important Notes -->
                <div class="card shadow border-0">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Important Notes
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0 small">
                            <li class="mb-2">correctAnswer is the index (0-3) of the correct option</li>
                            <li class="mb-2">timeAllocation is in seconds (60 = 1 minute)</li>
                            <li class="mb-2">All fields are required for each question</li>
                            <li class="mb-2">Quiz is saved locally and synced to Google Sheets</li>
                            <li>Maximum 50 questions per quiz recommended</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Quizzes Table -->
        <div class="card shadow border-0 mt-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>Recently Created Quizzes
                </h5>
                <span class="badge bg-light text-dark" id="quizCountBadge">0 quizzes</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th><i class="fas fa-calendar me-1"></i>Date</th>
                                <th><i class="fas fa-book me-1"></i>Subject</th>
                                <th><i class="fas fa-list-ol me-1"></i>Questions</th>
                                <th><i class="fas fa-clock me-1"></i>Time</th>
                                <th><i class="fas fa-info-circle me-1"></i>Created At</th>
                                <th><i class="fas fa-cog me-1"></i>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentQuizzesTable">
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="spinner-border text-secondary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 mb-0 text-muted">Loading quizzes...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-white text-center py-4 mt-5">
        <div class="container">
            <p class="mb-0">
                <i class="fas fa-shield-alt me-2"></i>
                Admin Panel - Daily Exam Quiz Portal &copy; 2025
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Custom JS -->
    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>

    <!-- Admin Panel Script -->
    <script>
        // Check API Connection on Load
        window.addEventListener('DOMContentLoaded', async function() {
            if (localStorage.getItem('quizAdmin') === 'authenticated') {
                document.getElementById('adminContent').style.display = 'block';
                loadRecentQuizzes();
                checkAPIConnection();
            } else {
                var loginModal = new bootstrap.Modal(document.getElementById('adminLoginModal'));
                loginModal.show();
            }
        });

        // Check API Connection Status
        async function checkAPIConnection() {
            const statusText = document.getElementById('apiStatusText');
            const statusAlert = document.getElementById('apiStatusAlert');
            
            try {
                if (window.QuizAPI && typeof window.QuizAPI.checkStatus === 'function') {
                    statusText.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking...';
                    
                    const isConnected = await window.QuizAPI.checkStatus();
                    
                    if (isConnected) {
                        statusText.innerHTML = '<i class="fas fa-check-circle me-2"></i>Google Sheets API Connected';
                        statusAlert.classList.remove('alert-info', 'alert-warning');
                        statusAlert.classList.add('alert-success');
                    } else {
                        throw new Error('Connection failed');
                    }
                } else {
                    throw new Error('API not loaded');
                }
            } catch (error) {
                statusText.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>API Offline - Data saved locally only';
                statusAlert.classList.remove('alert-info');
                statusAlert.classList.add('alert-warning');
                console.warn('Google Sheets API not available:', error);
            }
        }

        // Admin Login
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'admin123' || password.length >= 6) {
                localStorage.setItem('quizAdmin', 'authenticated');
                bootstrap.Modal.getInstance(document.getElementById('adminLoginModal')).hide();
                document.getElementById('adminContent').style.display = 'block';
                loadRecentQuizzes();
                checkAPIConnection();
                
                Swal.fire({
                    icon: 'success',
                    title: 'Login Successful!',
                    text: 'Welcome to Admin Panel',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                document.getElementById('loginErrorText').textContent = 'Invalid password! Minimum 6 characters required.';
                document.getElementById('loginError').style.display = 'block';
            }
        });

        // Admin Logout
        function adminLogout() {
            Swal.fire({
                title: 'Logout?',
                text: 'Are you sure you want to logout from Admin Panel?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Logout',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('quizAdmin');
                    window.location.href = 'index.html';
                }
            });
        }

        // Validate JSON
        function validateJSON() {
            const jsonText = document.getElementById('questionsJson').value;
            try {
                const questions = JSON.parse(jsonText);
                if (!Array.isArray(questions)) throw new Error('Must be an array of questions');
                
                questions.forEach((q, i) => {
                    if (!q.question || !q.options || !q.explanation) {
                        throw new Error(`Question ${i+1} is missing required fields`);
                    }
                    if (!Array.isArray(q.options) || q.options.length !== 4) {
                        throw new Error(`Question ${i+1} must have exactly 4 options`);
                    }
                    if (typeof q.correctAnswer !== 'number' || q.correctAnswer < 0 || q.correctAnswer > 3) {
                        throw new Error(`Question ${i+1} has invalid correctAnswer (must be 0-3)`);
                    }
                });
                
                document.getElementById('questionCount').textContent = questions.length;
                const totalMinutes = Math.ceil(questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0) / 60);
                document.getElementById('totalTime').textContent = totalMinutes + ' minutes';
                
                Swal.fire({
                    icon: 'success',
                    title: 'Valid JSON!',
                    text: `${questions.length} questions validated successfully`,
                    timer: 2000
                });
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid JSON',
                    text: err.message
                });
            }
        }

        // Auto-calculate on input
        document.getElementById('questionsJson').addEventListener('input', function() {
            try {
                const questions = JSON.parse(this.value);
                if (Array.isArray(questions)) {
                    document.getElementById('questionCount').textContent = questions.length;
                    const totalMinutes = Math.ceil(questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0) / 60);
                    document.getElementById('totalTime').textContent = totalMinutes + ' minutes';
                }
            } catch(e) {
                // Ignore parsing errors during typing
            }
        });

        // Quiz Creation Form Submit
        document.getElementById('quizCreationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const date = document.getElementById('quizDateInput').value;
            const subject = document.getElementById('subjectInput').value;
            const questionsJson = document.getElementById('questionsJson').value;
            
            try {
                const questions = JSON.parse(questionsJson);
                if (!Array.isArray(questions) || questions.length === 0) {
                    throw new Error('Questions must be a non-empty array');
                }
                
                const totalQuestions = questions.length;
                const timeLimit = questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0);
                
                const quizId = 'quiz_' + Date.now();
                const quizData = {
                    quizId,
                    date,
                    subject,
                    questions,
                    totalQuestions,
                    timeLimit,
                    createdAt: new Date().toISOString()
                };
                
                // Store in localStorage
                let quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                quizzes.push(quizData);
                localStorage.setItem('quizzes', JSON.stringify(quizzes));
                
                // Send to Google Sheets API
                try {
                    if (window.QuizAPI && typeof window.QuizAPI.createQuiz === 'function') {
                        Swal.fire({
                            title: 'Creating Quiz...',
                            html: '<i class="fas fa-spinner fa-spin fa-3x text-primary"></i><br><br>Sending data to Google Sheets',
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        const apiResult = await window.QuizAPI.createQuiz(quizData);
                        
                        if (apiResult && apiResult.status === 'success') {
                            Swal.fire({
                                icon: 'success',
                                title: 'Quiz Created!',
                                html: '<strong>Quiz created and saved to Google Sheets in under 60 seconds!</strong><br><br>' +
                                      `<i class="fas fa-check-circle text-success"></i> ${totalQuestions} questions added<br>` +
                                      `<i class="fas fa-clock text-primary"></i> ${Math.ceil(timeLimit/60)} minutes duration`,
                                confirmButtonColor: '#dc3545'
                            });
                        } else {
                            throw new Error(apiResult.message || 'API returned error');
                        }
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Saved Locally',
                            text: 'Quiz created locally. Google Sheets API not connected.',
                            confirmButtonColor: '#ffc107'
                        });
                    }
                } catch (apiError) {
                    console.error('Google Sheets API Error:', apiError);
                    Swal.fire({
                        icon: 'warning',
                        title: 'Partial Success',
                        text: 'Quiz created locally but failed to sync with Google Sheets. Check API connection.',
                        confirmButtonColor: '#ffc107'
                    });
                }
                
                // Reset form
                document.getElementById('quizCreationForm').reset();
                document.getElementById('questionCount').textContent = '0';
                document.getElementById('totalTime').textContent = '0 minutes';
                
                loadRecentQuizzes();
                
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: err.message,
                    confirmButtonColor: '#dc3545'
                });
            }
        });

        // Load Recent Quizzes
        function loadRecentQuizzes() {
            const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const tbody = document.getElementById('recentQuizzesTable');
            const countBadge = document.getElementById('quizCountBadge');
            
            countBadge.textContent = `${quizzes.length} quiz${quizzes.length !== 1 ? 'zes' : ''}`;
            
            if (quizzes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted"><i class="fas fa-inbox fa-3x mb-3 d-block"></i>No quizzes created yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = quizzes.slice(-10).reverse().map(quiz => `
                <tr>
                    <td><i class="fas fa-calendar-day me-2 text-primary"></i>${quiz.date}</td>
                    <td><i class="fas fa-book me-2 text-success"></i>${quiz.subject}</td>
                    <td><span class="badge bg-primary">${quiz.totalQuestions}</span></td>
                    <td><span class="badge bg-info">${Math.ceil(quiz.timeLimit / 60)} min</span></td>
                    <td class="small text-muted">${new Date(quiz.createdAt).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteQuiz('${quiz.quizId}')" title="Delete Quiz">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Delete Quiz
        function deleteQuiz(quizId) {
            Swal.fire({
                title: 'Delete Quiz?',
                text: 'This action cannot be undone!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Delete',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    let quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
                    quizzes = quizzes.filter(q => q.quizId !== quizId);
                    localStorage.setItem('quizzes', JSON.stringify(quizzes));
                    loadRecentQuizzes();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Deleted!',
                        text: 'Quiz has been deleted',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        // Copy Template to Clipboard
        function copyTemplate() {
            const template = `[
  {
    "question": "Your question here?",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "correctAnswer": 1,
    "explanation": "Detailed explanation here",
    "timeAllocation": 60
  }
]`;
            navigator.clipboard.writeText(template).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Copied!',
                    text: 'Template copied to clipboard',
                    timer: 1500,
                    showConfirmButton: false
                });
            }).catch(() => {
                Swal.fire({
                    icon: 'error',
                    title: 'Failed',
                    text: 'Could not copy to clipboard',
                    timer: 1500
                });
            });
        }
    </script>
</body>
</html>
