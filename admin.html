<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Quiz Creator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-danger sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">
        <i class="fas fa-shield-alt me-2"></i>Admin Panel
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="index.html">Home</a>
        <a class="nav-link" href="#" onclick="adminLogout()">Logout</a>
      </div>
    </div>
  </nav>

  <!-- Login Modal -->
  <div class="modal fade" id="adminLoginModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="fas fa-lock me-2"></i>Admin Authentication</h5>
        </div>
        <div class="modal-body">
          <div class="text-center mb-3">
            <i class="fas fa-user-shield fa-4x text-danger"></i>
          </div>
          <form id="adminLoginForm">
            <div class="mb-3">
              <label class="form-label">Admin Password</label>
              <input type="password" class="form-control" id="adminPassword" placeholder="Enter admin password" required minlength="6" />
              <small class="text-muted">Default: admin123</small>
            </div>
            <button type="submit" class="btn btn-danger w-100">
              <i class="fas fa-sign-in-alt me-2"></i>Login
            </button>
          </form>
          <div id="loginError" class="alert alert-danger mt-3" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Admin Content -->
  <main class="container my-5" id="adminContent" style="display:none;">
    <div class="row">
      <div class="col-lg-8">
        <div class="card shadow-lg border-0">
          <div class="card-header bg-danger text-white">
            <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Quiz</h4>
          </div>
          <div class="card-body">
            <form id="quizCreationForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Quiz Date *</label>
                  <input type="date" class="form-control" id="quizDateInput" name="date" required />
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Subject *</label>
                  <select class="form-select" id="subjectInput" name="subject" required>
                    <option value="">Select subject...</option>
                    <option value="General Knowledge">General Knowledge</option>
                    <option value="English">English</option>
                    <option value="Reasoning">Reasoning</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="General Studies">General Studies</option>
                    <option value="Current Affairs">Current Affairs</option>
                  </select>
                </div>
              </div>

              <div class="mt-3">
                <label class="form-label fw-semibold">Questions JSON *</label>
                <textarea
                  class="form-control font-monospace"
                  id="questionsJson"
                  name="questionsJson"
                  rows="15"
                  required
                  placeholder='Paste your questions in JSON format. Example:
[
  {
    "question": "What is the capital of India?",
    "options": ["Mumbai", "New Delhi", "Kolkata", "Chennai"],
    "correctAnswer": 1,
    "explanation": "New Delhi is the capital.",
    "timeAllocation": 60
  }
]'
                ></textarea>
                <div class="form-text">
                  <strong>Format Guide:</strong> Array of question objects. Each question needs: question, options, correctAnswer (index 0-3), explanation, and timeAllocation in seconds.
                </div>
              </div>

              <div class="mt-3 p-3 bg-light rounded">
                <div class="row">
                  <div class="col-md-4">
                    <strong>Total Questions:</strong>
                    <span id="questionCount" class="text-primary">0</span>
                  </div>
                  <div class="col-md-4">
                    <strong>Total Time:</strong>
                    <span id="totalTime" class="text-success">0 minutes</span>
                  </div>
                  <div class="col-md-4">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="validateJSON()">
                      <i class="fas fa-check me-1"></i>Validate JSON
                    </button>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <button type="submit" class="btn btn-danger btn-lg px-5" id="createQuizBtn">
                  <i class="fas fa-cloud-upload-alt me-2"></i>Create Quiz
                </button>
                <button type="reset" class="btn btn-outline-secondary btn-lg px-4 ms-2">
                  <i class="fas fa-redo me-2"></i>Reset
                </button>
              </div>
            </form>

            <div id="quizCreateStatus" class="alert alert-success mt-4" style="display:none;">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Success!</strong> Quiz created in under 60 seconds!
            </div>

            <div id="quizCreateError" class="alert alert-danger mt-4" style="display:none;"></div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card shadow border-0 mb-4">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Quick Guide</h5>
          </div>
          <div class="card-body">
            <ol class="mb-0">
              <li class="mb-2">Select quiz date and subject</li>
              <li class="mb-2">Paste questions in JSON format</li>
              <li class="mb-2">Click 'Validate JSON' to check format</li>
              <li class="mb-2">Review question count and time</li>
              <li>Click 'Create Quiz' to save</li>
            </ol>
          </div>
        </div>
        <div class="card shadow border-0">
          <div class="card-header bg-warning">
            <h5 class="mb-0"><i class="fas fa-code me-2"></i>JSON Template</h5>
          </div>
          <div class="card-body">
            <pre class="bg-light p-2 rounded small" style="font-size:11px;">
[
  {
    "question": "Your question?",
    "options": [
      "Option A",
      "Option B",
      "Option C",
      "Option D"
    ],
    "correctAnswer": 1,
    "explanation": "Explanation here",
    "timeAllocation": 60
  }
]
            </pre>
            <button class="btn btn-sm btn-warning w-100" onclick="copyTemplate()">
              <i class="fas fa-copy me-1"></i>Copy Template
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/utils.js"></script>
  <script src="js/api.js"></script>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('quizAdmin') === 'authenticated') {
        document.getElementById('adminContent').style.display = 'block';
        loadRecentQuizzes();
      } else {
        const loginModal = new bootstrap.Modal(document.getElementById('adminLoginModal'));
        loginModal.show();
      }
    });

    document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const pw = document.getElementById('adminPassword').value;
      if (pw === 'admin123' || pw.length >= 6) {
        localStorage.setItem('quizAdmin', 'authenticated');
        bootstrap.Modal.getInstance(document.getElementById('adminLoginModal')).hide();
        document.getElementById('adminContent').style.display = 'block';
        loadRecentQuizzes();
        Swal.fire('Success', 'Admin login successful!', 'success');
      } else {
        const err = document.getElementById('loginError');
        err.textContent = 'Invalid password!';
        err.style.display = 'block';
      }
    });

    function adminLogout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('quizAdmin');
        window.location.href = 'index.html';
      }
    }

    function validateJSON() {
      const jsonText = document.getElementById('questionsJson').value;
      try {
        const questions = JSON.parse(jsonText);
        if (!Array.isArray(questions)) throw new Error('Must be an array');
        questions.forEach((q, i) => {
          if (!q.question || !q.options || !q.explanation) throw new Error(`Question ${i + 1} is missing required fields`);
          if (q.options.length !== 4) throw new Error(`Question ${i + 1} must have exactly 4 options`);
        });
        document.getElementById('questionCount').textContent = questions.length;
        const totalMinutes = Math.ceil(questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0) / 60);
        document.getElementById('totalTime').textContent = totalMinutes + ' minutes';
        Swal.fire('Valid!', `${questions.length} questions validated successfully`, 'success');
      } catch (err) {
        Swal.fire('Invalid JSON', err.message, 'error');
      }
    }

    document.getElementById('questionsJson').addEventListener('input', function () {
      try {
        const questions = JSON.parse(this.value);
        if (Array.isArray(questions)) {
          document.getElementById('questionCount').textContent = questions.length;
          const totalMinutes = Math.ceil(questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0) / 60);
          document.getElementById('totalTime').textContent = totalMinutes + ' minutes';
        }
      } catch (e) { }
    });

    document.getElementById('quizCreationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const date = document.getElementById('quizDateInput').value;
      const subject = document.getElementById('subjectInput').value;
      const questionsJson = document.getElementById('questionsJson').value;
      try {
        const questions = JSON.parse(questionsJson);
        if (!Array.isArray(questions) || questions.length === 0) throw new Error('Must be a non-empty array');
        const totalQuestions = questions.length;
        const timeLimit = questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0);
        // Save quiz via API
        const result = await QuizAPI.createQuiz({
          date, subject, questions, totalQuestions, timeLimit
        });
        if (result.status === 'success') {
          document.getElementById('quizCreateStatus').style.display = 'block';
          document.getElementById('quizCreationForm').reset();
          document.getElementById('questionCount').textContent = '0';
          document.getElementById('totalTime').textContent = '0 minutes';
          loadRecentQuizzes();
          Swal.fire('Success!', 'Quiz created successfully!', 'success');
        } else {
          throw new Error(result.message || 'Failed to create quiz');
        }
      } catch (err) {
        const errorDiv = document.getElementById('quizCreateError');
        errorDiv.textContent = 'Error: ' + err.message;
        errorDiv.style.display = 'block';
        setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
      }
    });

    async function loadRecentQuizzes() {
      try {
        const response = await QuizAPI.getQuizzes();
        const quizzes = response.data.quizzes || [];
        const tbody = document.getElementById('recentQuizzesTable');
        if (quizzes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center">No quizzes created yet</td></tr>';
          return;
        }
        tbody.innerHTML = quizzes.slice(-10).reverse().map(q => `
          <tr>
            <td>${q.date}</td>
            <td>${q.subject}</td>
            <td>${q.totalQuestions}</td>
            <td>${Math.ceil(q.timeLimit / 60)}</td>
            <td>${new Date(q.createdAt).toLocaleString()}</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteQuiz('${q.quizId}')">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        Swal.fire('Error', 'Failed to load quizzes', 'error');
      }
    }

    function deleteQuiz(quizId) {
      if (confirm('Are you sure you want to delete this quiz?')) {
        // You need to implement deletion on the backend
        Swal.fire('Info', 'Deletion feature coming soon!', 'info');
      }
    }

    function copyTemplate() {
      const template = `[
  {
    "question": "Your question here?",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "correctAnswer": 1,
    "explanation": "Explanation here",
    "timeAllocation": 60
  }
]`;
      navigator.clipboard.writeText(template).then(() => {
        Swal.fire('Copied!', 'Template copied to clipboard', 'success');
      });
    }
  </script>
</body>
</html>
