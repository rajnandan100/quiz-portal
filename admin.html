<script>
// Admin authentication
window.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('quizAdmin') === 'authenticated') {
        document.getElementById('admin-login').style.display = 'none';
        document.getElementById('admin-form').style.display = 'block';
        loadRecentQuizzes();
    } else {
        var loginModal = new bootstrap.Modal(document.getElementById('adminLoginModal'));
        loginModal.show();
    }
});

document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const password = document.getElementById('adminPassword').value;
    
    if (password === 'admin123' || password.length >= 6) {
        localStorage.setItem('quizAdmin', 'authenticated');
        bootstrap.Modal.getInstance(document.getElementById('adminLoginModal')).hide();
        document.getElementById('adminContent').style.display = 'block';
        loadRecentQuizzes();
        Swal.fire('Success', 'Admin login successful!', 'success');
    } else {
        document.getElementById('loginError').textContent = 'Invalid password!';
        document.getElementById('loginError').style.display = 'block';
    }
});

function adminLogout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('quizAdmin');
        window.location.href = 'index.html';
    }
}

function validateJSON() {
    const jsonText = document.getElementById('questionsJson').value;
    try {
        const questions = JSON.parse(jsonText);
        if (!Array.isArray(questions)) throw new Error('Must be an array');
        
        questions.forEach((q, i) => {
            if (!q.question || !q.options || !q.explanation) {
                throw new Error(`Question ${i+1} is missing required fields`);
            }
            if (q.options.length !== 4) {
                throw new Error(`Question ${i+1} must have exactly 4 options`);
            }
        });
        
        document.getElementById('questionCount').textContent = questions.length;
        const totalMinutes = Math.ceil(questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0) / 60);
        document.getElementById('totalTime').textContent = totalMinutes + ' minutes';
        
        Swal.fire('Valid!', `${questions.length} questions validated successfully`, 'success');
    } catch (err) {
        Swal.fire('Invalid JSON', err.message, 'error');
    }
}

document.getElementById('questionsJson').addEventListener('input', function() {
    try {
        const questions = JSON.parse(this.value);
        if (Array.isArray(questions)) {
            document.getElementById('questionCount').textContent = questions.length;
            const totalMinutes = Math.ceil(questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0) / 60);
            document.getElementById('totalTime').textContent = totalMinutes + ' minutes';
        }
    } catch(e) {
        // Ignore during typing
    }
});

document.getElementById('quizCreationForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const date = document.getElementById('quizDateInput').value;
    const subject = document.getElementById('subjectInput').value;
    const questionsJson = document.getElementById('questionsJson').value;
    
    try {
        const questions = JSON.parse(questionsJson);
        if (!Array.isArray(questions) || questions.length === 0) {
            throw new Error('Questions must be a non-empty array');
        }
        
        const totalQuestions = questions.length;
        const timeLimit = questions.reduce((sum, q) => sum + (q.timeAllocation || 60), 0);
        
        const quizId = 'quiz_' + Date.now();
        const quizData = {
            quizId,
            date,
            subject,
            questions,
            totalQuestions,
            timeLimit,
            createdAt: new Date().toISOString()
        };
        
        // Store in localStorage
        let quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
        quizzes.push(quizData);
        localStorage.setItem('quizzes', JSON.stringify(quizzes));
        
        // Show success
        Swal.fire('Success!', 'Quiz created in under 60 seconds!', 'success');
        document.getElementById('quizCreationForm').reset();
        document.getElementById('questionCount').textContent = '0';
        document.getElementById('totalTime').textContent = '0 minutes';
        
        loadRecentQuizzes();
        
    } catch (err) {
        Swal.fire('Error', err.message, 'error');
    }
});

function loadRecentQuizzes() {
    const quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
    const tbody = document.getElementById('recentQuizzesTable');
    
    if (quizzes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No quizzes created yet</td></tr>';
        return;
    }
    
    tbody.innerHTML = quizzes.slice(-10).reverse().map(quiz => `
        <tr>
            <td>${quiz.date}</td>
            <td><i class="fas fa-book me-1"></i>${quiz.subject}</td>
            <td><span class="badge bg-primary">${quiz.totalQuestions}</span></td>
            <td>${Math.ceil(quiz.timeLimit / 60)} min</td>
            <td class="small">${new Date(quiz.createdAt).toLocaleString()}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="deleteQuiz('${quiz.quizId}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function deleteQuiz(quizId) {
    if (confirm('Are you sure you want to delete this quiz?')) {
        let quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
        quizzes = quizzes.filter(q => q.quizId !== quizId);
        localStorage.setItem('quizzes', JSON.stringify(quizzes));
        loadRecentQuizzes();
        Swal.fire('Deleted!', 'Quiz has been deleted', 'success');
    }
}

function copyTemplate() {
    const template = `[
  {
    "question": "Your question here?",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "correctAnswer": 1,
    "explanation": "Explanation here",
    "timeAllocation": 60
  }
]`;
    navigator.clipboard.writeText(template).then(() => {
        Swal.fire('Copied!', 'Template copied to clipboard', 'success');
    });
}
</script>
